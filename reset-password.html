<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>dMusik – Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:-apple-system,system-ui,sans-serif; background:#0f1115; color:#e6e6e6; display:grid; place-items:center; min-height:100vh; }
    .card { width:min(420px,92vw); background:#151822; border-radius:14px; border:1px solid #222638; padding:24px; box-shadow:0 8px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:20px; }
    p { margin:0 0 14px; font-size:14px; color:#a6adbb; }
    label { display:block; margin-top:12px; font-size:13px; color:#a6adbb; }
    input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3042; background:#0f1320; color:#e6e6e6; outline:none; }
    input:focus { border-color:#3e63ff; box-shadow:0 0 0 3px rgba(62,99,255,.25); }
    button { margin-top:16px; width:100%; padding:11px 14px; border-radius:10px; border:0; background:#ff6a00; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; color:#8f96a3; margin-top:6px; }
    .err { color:#ff5d5d; }
    .ok { color:#2bd97c; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Set a new password</h1>
    <p id="status">Validating your reset link…</p>

    <form id="form" style="display:none;">
      <label for="password">New password</label>
      <input id="password" type="password" autocomplete="new-password" minlength="8" required />

      <label for="confirm">Confirm new password</label>
      <input id="confirm" type="password" autocomplete="new-password" minlength="8" required />

      <button id="submit" type="submit">Update password</button>
      <div id="message" class="hint"></div>
    </form>

    <div id="done" class="ok" style="display:none;">
      Your password has been updated. You can now return to the app.
    </div>

    <div id="error" class="err" style="display:none;"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // CDN fallback (helps on some mobile networks / blockers)
  if (!window.supabase) {
    const s = document.createElement('script');
    s.src = "https://unpkg.com/@supabase/supabase-js@2";
    document.head.appendChild(s);
  }
</script>

<script>
  const supabaseUrl = "https://vmdfroxjiidwghhomwqk.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZGZyb3hqaWlkd2doaG9td3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjI1MDEsImV4cCI6MjA3MzE5ODUwMX0.Di7xe2wWeoFv_5afopx-Gw9IjOPn-Z63rvy8uPdsUf8";

  const statusEl = document.getElementById('status');
  const formEl = document.getElementById('form');
  const doneEl = document.getElementById('done');
  const errorEl = document.getElementById('error');
  const msgEl = document.getElementById('message');
  const submitBtn = document.getElementById('submit');
  const pwdEl = document.getElementById('password');
  const confirmEl = document.getElementById('confirm');

  function showError(title, message) {
    statusEl.textContent = title;
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    formEl.style.display = 'none';
  }

  function withTimeout(promise, ms = 12000) {
    return Promise.race([
      promise,
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timed out contacting Supabase. Please refresh and try again.')), ms)
      )
    ]);
  }

  async function waitForSupabase(ms = 8000) {
    const start = Date.now();
    while (!(window.supabase && window.supabase.createClient)) {
      if (Date.now() - start > ms) return false;
      await new Promise(r => setTimeout(r, 50));
    }
    return true;
  }

  function getAllParams() {
    const search = new URLSearchParams(window.location.search);
    const hash = new URLSearchParams(window.location.hash.replace('#',''));
    return { search, hash };
  }

  async function establishSession(client) {
    const { search, hash } = getAllParams();

    const code = search.get('code');
    const tokenHash = search.get('token_hash');
    const type = search.get('type');
    const accessToken = hash.get('access_token');
    const refreshToken = hash.get('refresh_token');

    // 1) PKCE code flow
    if (code) {
      const { error } = await withTimeout(client.auth.exchangeCodeForSession(code), 12000);
      if (error) throw error;
      return;
    }

    // 2) token_hash recovery flow
    if (tokenHash && type === 'recovery') {
      const { error } = await withTimeout(
        client.auth.verifyOtp({ type: 'recovery', token_hash: tokenHash }),
        12000
      );
      if (error) throw error;
      return;
    }

    // 3) Fragment access_token flow
    if (accessToken && refreshToken) {
      const { error } = await withTimeout(
        client.auth.setSession({ access_token: accessToken, refresh_token: refreshToken }),
        12000
      );
      if (error) throw error;
      return;
    }

    // 4) Already have session?
    const { data } = await withTimeout(client.auth.getSession(), 12000);
    if (data?.session) return;

    throw new Error('Invalid or expired reset link. Please request a new password reset from the app.');
  }

  (async function init() {
    try {
      statusEl.textContent = 'Validating your reset link…';

      const ok = await waitForSupabase();
      if (!ok) {
        showError(
          'Could not validate the reset link.',
          'Supabase script failed to load (possibly blocked by content blockers). Please refresh or disable blockers and try again.'
        );
        return;
      }

      const client = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      await establishSession(client);

      statusEl.textContent = 'Enter your new password.';
      formEl.style.display = 'block';
    } catch (err) {
      console.error('init error:', err);
      showError(
        'Invalid or expired reset link.',
        (err && err.message) ? err.message : 'Please request a new password reset from the app.'
      );
    }
  })();

  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    msgEl.textContent = '';
    errorEl.style.display = 'none';

    const pwd = (pwdEl.value || '').trim();
    const conf = (confirmEl.value || '').trim();

    if (pwd.length < 8) {
      msgEl.textContent = 'Password must be at least 8 characters.';
      return;
    }
    if (pwd !== conf) {
      msgEl.textContent = 'Passwords do not match.';
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating…';

    try {
      const client = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
      const { error } = await withTimeout(client.auth.updateUser({ password: pwd }), 12000);

      if (error) {
        console.error('updateUser error:', error);
        errorEl.textContent = error.message || 'Could not update password.';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update password';
        return;
      }

      formEl.style.display = 'none';
      statusEl.textContent = 'Success';
      doneEl.textContent = 'Your password has been updated. You can return to the app now.';
      doneEl.style.display = 'block';
      history.replaceState(null, '', location.pathname);
    } catch (err) {
      console.error('update error:', err);
      errorEl.textContent = (err && err.message) ? err.message : 'Network error. Please try again.';
      errorEl.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update password';
    }
  });
</script>
  
</body>
</html>

